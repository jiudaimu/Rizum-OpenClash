# ============================
# OpenClash 全注释配置文件
# 版本：v4.1
# ============================

# 基础网络配置
mixed-port: 7890          # 混合代理端口 (HTTP/SOCKS5 共用)
redir-port: 7892          # 透明代理端口 (用于 iptables 重定向)
tproxy-port: 7893         # TProxy 透明代理端口 (支持 UDP)
allow-lan: true           # 允许局域网设备连接代理
mode: Rule                # 使用规则分流模式 (可选 Global/Rule/Direct)
log-level: warning        # 日志级别 (silent/error/warning/info/debug)
external-controller: 0.0.0.0:9090  # RESTful API 监听地址 (管理面板使用)
secret: "your_password"   # API 访问密钥 (建议使用强密码)
ipv6: true                # 启用 IPv6 双栈支持
geodata-mode: true        # 使用新版 GeoIP 数据库格式

# DNS 系统配置 (防止污染)
dns:
  enable: true            # 启用自定义 DNS 服务器
  listen: 0.0.0.0:1053    # DNS 服务监听端口
  ipv6: true              # 响应 IPv6 DNS 查询
  enhanced-mode: fake-ip  # 使用 Fake-IP 模式提升响应速度
  fake-ip-range: 198.18.0.1/16  # Fake-IP 地址池 (避免与真实 IP 冲突)
  default-nameserver:     # 初始 DNS 服务器 (用于解析 nameserver 域名)
    - 223.5.5.5           # 阿里公共 DNS
    - 2400:3200::1        # 阿里 IPv6 DNS
  nameserver:             # 常规 DNS 服务器 (按顺序查询)
    - https://doh.pub/dns-query  # 腾讯 DoH (加密 DNS)
    - tls://dns.alidns.com:853   # 阿里 DoT (加密 DNS)
  fallback-filter:        # 回退过滤规则
    geoip: true           # 非中国 IP 使用 fallback
    ipcidr:               # IP 段过滤规则
      - 240.0.0.0/4       # 过滤非常规 IP 段

# 订阅源配置 (需用户替换 SUB_URL)
proxy-providers:
  main_sub:               # 订阅源名称
    type: http            # 订阅类型 (http/file)
    url: "SUB_URL"        # 订阅链接 (需用户填写)
    path: ./subs/main.yaml  # 本地存储路径
    interval: 43200       # 更新间隔 (秒，12 小时)
    filter: "香港|台湾|回国|(?i)hk|tw|cn"  # 正则过滤节点名称
    health-check:         # 节点健康检查
      enable: true        # 启用自动检测
      interval: 300       # 检查间隔 (5 分钟)
      url: http://connect.rom.miui.com/generate_204  # 检测地址 (国内可达)

# 代理策略组架构
proxy-groups:
  - name: "🚀 智能优选"    # 策略组显示名称
    type: url-test        # 类型：延迟测试 (自动选择最低延迟节点)
    url: http://www.qualcomm.cn/generate_204  # 测试地址 (国内服务器)
    interval: 300         # 测试间隔 (5 分钟)
    tolerance: 50         # 允许延迟差 (单位 ms，50ms 内不切换)
    use: [main_sub]       # 使用订阅源中的节点
  
  - name: "📺 哔哩专线"    # 流媒体专用组
    type: select          # 类型：手动选择
    proxies:              # 可用节点列表
      - "🚀 智能优选"      # 首选智能优选节点
      - DIRECT            # 备选直连
  
  - name: "🎮 VR通道"          # 策略组名称 (显示在控制面板)
    type: url-test           # 类型：自动选择延迟最低节点
    url: http://www.qualcomm.cn/generate_204  # 测试地址 (国内可达性检测)
    interval: 300            # 测试间隔 300 秒 (5 分钟)
    tolerance: 50            # 允许 50ms 延迟差 (波动小于此值不切换)
    timeout: 2000            # 超时时间 2000ms (2 秒)
    use: [main_sub]          # 使用 main_sub 订阅源的节点
    filter: "香港|(?i)hk"     # 正则过滤香港节点 (中文/英文标识)
    # proxies:               # 如需手动指定节点可取消注释
    #   - 香港节点01
    #   - 香港节点02

# 流量规则系统 (按优先级匹配)
rules:
  # 特殊应用规则 (最高优先级)
  - DOMAIN,bil.ouo.chat,🎮 VR通道,no-resolve  # 指定域名走 VR 通道，不触发 DNS 解析
  - DOMAIN-SUFFIX,91vrchat.com,🎮 VR通道      # 匹配所有子域名
  
  # 流媒体规则 (次优先级)
  - DOMAIN-SUFFIX,bilibili.com,📺 哔哩专线    # 主站域名
  - DOMAIN-KEYWORD,upos,📺 哔哩专线          # CDN 服务器关键字
  
  # 国内直连规则 (最后匹配)
  - GEOIP,CN,DIRECT,no-resolve              # 中国 IP 直连 (不触发解析)
  - MATCH,🚀 智能优选                       # 剩余流量走智能优选

# TUN 模式配置 (增强模式)
tun:
  enable: true            # 启用 TUN 模式 (需要内核支持)
  stack: system           # 使用系统协议栈 (gvisor/system)
  auto-route: true        # 自动设置路由规则
  auto-detect-interface: true  # 自动检测网络接口

# 实验性功能
experimental:
  ignore-resolve-fail: true  # 忽略 DNS 解析失败 (防止断流)
  sniff-tls-sni: true     # 启用 TLS SNI 嗅探 (增强分流精度)

# 规则集自动更新
rule-providers:
  streaming_cn:           # 国内流媒体规则集
    type: http            # 远程获取类型
    behavior: domain      # 匹配域名类型规则
    url: https://cdn.jsdelivr.net/gh/DivineEngine/Profiles@master/Clash/RuleSet/StreamingMedia/StreamingCN.yaml
    path: ./rulesets/streaming_cn.yaml  # 本地存储路径
    interval: 86400       # 每天自动更新
